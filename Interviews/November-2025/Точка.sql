--Задача 1
--
--- Объяснить, в чём принципиальная разница в результате между этими двумя запросами.

-- Вариант 1
SELECT ...
FROM t1 AS a
LEFT JOIN t2 AS b
    ON a.id = b.id
WHERE b.id >= 5;

WHERE удаляет:
все строки, где b.id < 5,
все строки, где b.id IS NULL.
В итоге остаются только строки, где нашлась пара в t2 с id >= 5.

-- Вариант 2
SELECT ...
FROM t1 AS a
LEFT JOIN t2 AS b
    ON a.id = b.id AND b.id >= 5;

 все строки из t1 присутствуют, независимо от того, есть ли подходящий b.id >= 5.








--- На небольшом примере данных (в том числе с значениями `2`, `5`, `10`) показать, какие строки попадут в результат каждого запроса.

t1:
id
--
1
2
5
10

t2:
id
--
2
5
10


SELECT ...
FROM t1 AS a
LEFT JOIN t2 AS b
    ON a.id = b.id
WHERE b.id >= 5;

| a.id | b.id |
| ---: | ---: |
|    5 |    5 |
|   10 |   10 |


SELECT ...
FROM t1 AS a
LEFT JOIN t2 AS b
    ON a.id = b.id AND b.id >= 5;

| a.id | b.id |
| ---: | ---: |
|    1 | NULL |
|    2 | NULL |
|    5 |    5 |
|   10 |   10 |





--Задача 2
--
--Есть два запроса, каждый возвращает одну колонку `id`. Нужно проверить, что их результаты полностью идентичны с точностью до порядка строк (то есть множества значений совпадают), при этом возможны значения `NULL`.
--
--Задача:
--
--- Написать SQL-скрипт, который позволит однозначно ответить на вопрос: совпадают ли результаты этих двух выборок или нет.
--- Учесть аккуратную работу с `NULL` (в том числе случай, когда `NULL`встречается в обеих выборках, и когда он есть только в одной).
--- Желательно, чтобы финальный вывод сводился к простому условию: «есть отличия / отличий нет».

Если мы хотим проверить равенство множеств Q1 и Q2, нужно, чтобы:

- во первой выборке не было значений, которых нет во второй,
- и во второй не было значений, которых нет в первой.

То есть должны быть пустыми обе разности:

(Q1 EXCEPT Q2)
UNION
(Q2 EXCEPT Q1)


with
q1 as (
    -- первый запрос
    select id from ...
),
q2 as (
    -- второй запрос
    select id from ...
),
diff as (
    -- симметрическая разность
    (select id from q1
     except
     select id from q2)
    union
    (select id from q2
     except
     select id from q1)
)
select case
         when exists (select 1 from diff)
           then 'есть отличия'
           else 'отличий нет'
       end as compare_result;





--Задача 3
В компании есть отдел, который обзванивает клиентов и продаёт им продукт. Руководству нужно понять, оставлять ли этот отдел в следующем году или закрывать.

Известно:

Оператор делает около 100 звонков в день.
Конверсия в подключение по результатам обзвона — 5%.
С одной продажи компания получает 3000 ₽ (считать это чистой маржой).
Зарплата сотрудника — порядка 70 000 ₽ в месяц + налоги (итого около 100 000 ₽ совокупных затрат).
Без обзвона есть «естественная» конверсия клиентов в подключение — 3%.
Нужно:

Предложить, какие метрики и расчёты нужно сделать, чтобы решить, выгоден ли отдел обзвона.
Показать, как учесть естественную конверсию (3%) и выделить именно дополнительный эффект от работы оператора.
Сравнить дополнительную выручку/маржу с затратами на отдел и сделать вывод, стоит ли его оставлять.





1. 3% — это конверсия ровно этой базы за тот же период и с теми же условиями, что и обзванивает оператор?
2. **Быстрые прикидки по цифрам (на 1 оператора)**
    - Звонков: 100/день ⇒ ~2 200/мес (22 раб. дня).
    - Конверсия «со звонками»: 5% ⇒ 110 продаж/мес.
    - Естественная конверсия (если бы не звонили): 3% ⇒ 66 продаж/мес среди тех же 2 200.
    - Дополнительные продажи от обзвона: 110 − 66 = 44 / мес.
    - Маржа за продажу: 3 000 ₽ ⇒ инкр. маржа = 44 × 3 000 = 132 000 ₽/мес.
    - Затраты на оператора (всё включено): 100 000 ₽/мес.

    Итог: инкр. прибыль ≈ 132 000 − 100 000 = +32 000 ₽/мес на оператора. На отдел — умножить на число операторов (и добавить оверхед).

3. Метрики:
    - разницу конверсий в подключение со звонком и без звонка оператора. Рзвонок - Рбез звонка.
    - маржа с каждого оператора: (Рзвонок - Рбез звонка)* маржа за продажу
4. как учесть естественную конверсию (3%) и выделить именно дополнительный эффект от работы оператора.

    Лучше всего — A/B на клиентах:

    Случайно делим  клиентов на:

    - А (call‐assigned): оператор пытается звонить.
    - В (holdout): никому не звонят в течение окна (например, 14 дней).

    Считаем конверсию в заказ в окне по всем из каждой группы

5. Сравнить дополнительную выручку/маржу с затратами на отдел и сделать вывод, стоит ли его оставлять.

    CAC за дополнительный заказ = 100 000 / 44 ≈ 2 273 ₽ (меньше маржи 3 000 ₽ → юнит-экономика положительная).

    где Дополнительные продажи от обзвона: 110 − 66 = 44 / мес.









--
